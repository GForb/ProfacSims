---
title: "Prediction with new data for intercepts"
format: html
editor: visual
---

```{r echo = FALSE}
library(tidyverse)
library(DBI)
library(RSQLite)
library(here)
library(glue)

# Connecting to database
table = "sim_results_v4"
sim_name = "240119-pred-new-data"
where = glue("sim_name = '{sim_name}'")

db <- dbConnect(RSQLite::SQLite(), here("Results/Database/sim_results.db"))

```

## Intro
Simulations comparing random intercept to fixed intercept when there is 


## Simulation Parameters

## Checking n's
```{r, echo = FALSE}

colnames <- dbGetQuery(db,
           glue("SELECT * FROM {table} WHERE 1 = 0"))



counts <- DBI::dbGetQuery(db,
            glue("SELECT n_studies, ICC, R2, study_sample_size_train, model, predict_method, intercept_est_sample_size, metric, COUNT(*) 
            FROM {table}
            WHERE {where}
            GROUP BY n_studies, ICC, R2, study_sample_size_train, model, predict_method, intercept_est_sample_size, metric")
)
counts_col <- counts[,"COUNT(*)"]
min_sim_rep <- min(counts_col)
max_sim_rep <- max(counts_col)




```
Across all scenarios, the minimum number of sim reps with results is `r min_sim_rep` and the maximum number is `r max_sim_rep`.

## Random intercept models underestimate variance of intercepts whent there are a small number of studies



```{r, echo = FALSE}



random_models <-  DBI::dbGetQuery(db,
  glue(
    "SELECT n_studies, ICC, R2, study_sample_size_train, model, predict_method, intercept_est_sample_size, metric, est, error_var_u, sigma_u
    FROM {table}
    WHERE {where} AND intercept_est_sample_size = 10 AND (predict_method = 'new0' OR predict_method = 'new_dynamic') AND metric = 'var_u' AND (model ='Random intercetp - ML' OR model = 'Random intercetp - REML')
  ")
)
# plot n
summaries_var_u <- random_models |> 
  group_by(n_studies, ICC, R2, study_sample_size_train, model, predict_method) |> 
  summarise(sigma2_u = mean((sigma_u^2)),
            est_sigma_u = mean(est),
            value = mean(error_var_u), 
            sd = sd(error_var_u),
            ll = ProfacSims:::robust_t_test(error_var_u)[1], 
            ul = ProfacSims:::robust_t_test(error_var_u)[2],  
            n = sum(!is.na(error_var_u))) |> 
  ungroup() |> 
  mutate(perc_error_var_u = value/sigma2_u*100)



min_converge <- min(summaries_var_u$n)
max_converge <- max(summaries_var_u$n)


```
### Number of models converging
Across all scenarios and models including a random component, the minimum number of models reporting a random intercept variance is `r min_converge` and the maximum number is `r max_converge`.


```{r}
n <- summaries_var_u |> filter(model == "Random intercetp - REML" | model == "Random intercetp - ML") |> select(n)
min(n)
max(n)
```


```{r, fig.height = 6}
summaries_var_u |> 
  ProfacSims:::plot_error_var_u()
```


```{r, fig.height = 6}
summaries_var_u |> 
  dplyr::filter(predict_method == "new0") |> 
  ProfacSims:::box_plot_error_var_u()



```


